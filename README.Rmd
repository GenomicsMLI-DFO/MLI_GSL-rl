---
title: "GSL-rl : Gulf of St. Lawrence reference library"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Library

library(tidyverse)

# Read the dataset

metadata   <- readr::read_csv("GSL-rl_COI/GSL-rl_COI_metadata.csv")

#write_csv(metadata, "GSL-rl_COI/GSL-rl_COI_metadata.csv")
#DNA.leray  <- Biostrings::readDNAStringSet("GSL-rl_COI/GSL-rl_COI_Leray313pb_450taxa_1040seq.fasta")
#DNA.folmer <- Biostrings::readDNAStringSet("GSL-rl_COI/GSL-rl_COI_Folmer650pb_450taxa_1304seq.fasta")

#Biostrings::writeXStringSet(DNA.folmer.cor, "GSL-rl_COI/GSL-rl_COI_Folmer650pb_450taxa_1304seq.fasta")

#

colorBlindBlack8  <- c("#000000", "#E69F00", "#56B4E9", "#009E73", 
                       "#F0E442", "#0072B2", "#D55E00", "#CC79A7")



```

Reference sequences for metabarcording species assignments in the Gulf of St. Lawrence

__Main maintainer:__  Audrey Bourret  
__Affiliation:__  Fisheries and Oceans Canada (DFO)   
__Group:__        Laboratory of genomics   
__Location:__     Maurice Lamontagne Institute  
__Affiliated publication:__  Maximizing the reliability and the number of species assignments in metabarcoding studies (in prepatation). Bourret, A., Nozères, C., Parent, É., Parent, G.J.  
__Contact:__      audrey.bourret@dfo-mpo.gc.ca

- [Description of GSL-rl](#description-of-gsl-rl)
- [Status](#status)
- [Contents](#contents)
  + [Subsections within contents](#subsections-within-contents)
- [Requirements](#requirements)
- [Caveats](#caveats)
- [Uncertainty](#uncertainty)
- [Acknowledgements](#acknowledgements)
- [References](#references)


## Description of the GSL-rl

GSL-rl is a collection of curated and annotated sequences for performing genetic assignments using COI barcodes for marine fauna in the Gulf of St. Lawrence. It actually covered `r metadata %>% dplyr::filter(WithinNWA == "Yes", Level == "Species") %>%  nrow()` targeted species, and sequences are currently available for **`r metadata %>% dplyr::filter(WithinNWA == "Yes", Level == "Species", Validity != "No sequences available") %>%  nrow()` species**.

```{r echo=FALSE, message=FALSE, warning=FALSE}
metadata %>% dplyr::filter(WithinNWA == "Yes", Level == "Species") %>%  
  mutate( Validity = factor(Validity, levels = c("Reliable",  "Unreliable - BIN sharing","Unreliable - gaps", "No sequences available"))) %>% 
                         group_by(phylum, Validity) %>% 
  summarise(N = n()) %>% 
  mutate(SUM = sum(N),
       freq = N / sum(N)) %>% 
  ggplot(aes(x = 1, y = freq, fill = Validity)) +
  geom_bar(width = , stat = "identity", color = "gray10", cex = 0.2) +
  coord_polar("y", start = 0) + 
  scale_fill_manual(name = "Species detection category", 
                    values = c(colorBlindBlack8[4], colorBlindBlack8[5], colorBlindBlack8[2],"gray"))+

  geom_text(aes(y = 0.1, label = paste0("n=",SUM)), vjust = 4, col = "black", cex = 3) +
  facet_wrap(~phylum, nrow = 3) + theme_void() +
  theme(legend.title = element_blank(),
        legend.position = "bottom",
        plot.background = element_rect(fill = "white", colour = NA),
        plot.margin = margin(t = 20, r = 10, b = 10, l = 10, unit = "pt"))
  
```


## Status
"Ongoing-improvements"

## Contents

### Folder structure

```
.
├── GSL-rl_COI     # Main folder containing reference sequences for COI 
└── README.md
```

### GSL-rl COI

Two fasta files are available, one for the full fragment (~650 pb; Folmer) and another one cut to fit common smaller metabarcoding region (~313 pb; Leray). The smaller fragment is also composed of less sequences because exact duplicated sequences were removed.

- GSL-rl_COI_Folmer650pb_450taxa_1304seq.fasta  
- GSL-rl_COI_Leray313pb_450taxa_1040seq.fasta

```{r}
DNA.folmer <- Biostrings::readDNAStringSet("GSL-rl_COI/GSL-rl_COI_Folmer650pb_450taxa_1304seq.fasta")
DNA.folmer
```

Sequence name follows this nomenclature:  *BOLD/NCBI Unique ID* _ Root _  *Kingdom* _ *Phylum* _ *Class* _ *Order* _  *Family* _ *Genus* _ *Species* 


```{r}
names(DNA.folmer)[c(1, 10, 100)]

```

IDtaxa trained dataset 


Metadata included the species rank category, that can be retrieve easily.

```{r message=FALSE, warning=FALSE}
metadata   <- readr::read_csv2("GSL-rl_COI/GSL-rl_COI_metadata.csv")

metadata %>% dplyr::filter(str_detect(Name, "Ammodytes")) %>% dplyr::select(Name, SEQavailable, BIN, SPsharingBIN, Validity) 

metadata %>% dplyr::filter(family == "Asteriidae") %>% dplyr::select(Name, SEQavailable, BIN, SPsharingBIN, SPmissingSEQ.genus, Validity) 


```

The species rank category can be explore and add as a layer of information on metabarcoding results.

```{r echo=FALSE, fig.height=4, message=FALSE, warning=FALSE}

metadata %>% dplyr::filter(WithinNWA == "Yes", 
                           Level == "Species",
                           phylum == "Porifera"#,
                           #Validity != "No sequences available"
                           ) %>% #head() %>% 
  mutate( Validity = factor(Validity, levels = c("Reliable",  "Unreliable - BIN sharing","Unreliable - gaps", "No sequences available"))) %>% 
    ggplot(aes(y = "0", x = Name, fill = Validity)) +
 geom_point(pch = 21, cex = 3) + 
   facet_grid( phylum ~ order,  space = "free", scale = "free") + 
  theme_bw() +  
  scale_fill_manual(name = "Species detection category", 
                    breaks =  c("Reliable",  "Unreliable - BIN sharing","Unreliable - gaps", "No sequences available"),
                    values = c(colorBlindBlack8[4], colorBlindBlack8[5], colorBlindBlack8[2],"gray"))+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        axis.text.y = element_blank(),
        strip.text.x = element_text(angle = 90),
        axis.title = element_blank(),
        legend.position = "bottom")
          

                      
```



## Requirements
*Optional section.* List the input data requirements or software requirements to successfully execute the code.


## Caveats
Anything other users should be aware of including gaps in the input or output data and warnings about appropriate use.


## Uncertainty
*Optional section.* Is there some uncertainty associated with the output? Assumptions that were made?


## Acknowledgements
*Optional section.* List any contributors and acknowledge relevant people or institutions


## References
*Optional section.*
